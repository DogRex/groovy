<project name="GroovyJ" default="build.all" basedir=".">

    <target name="check.ant.version">
        <echo taskname="ant.version" message="${ant.version}"/>

        <condition property="ant.version.ok">
            <or>
                <contains string="${ant.version}" substring="1.6.2" casesensitive="false"/>
            </or>
        </condition>
    </target>

    <target name="ant.version.pass" depends="check.ant.version" unless="ant.version.ok">
        <fail>This build script requires Ant 1.6.2 or later!</fail>
    </target>

    <target name="initialise.build" depends="ant.version.pass">
        <!-- Project properties -->
        <property file="project.properties"/>

        <!-- Default project properties if not found in project.properties -->
        <property name="project.name" value="Set name in project.properties"/>
        <property name="project.title" value="Set title in project.properties"/>
        <property name="project.version" value="dev"/>
        <property name="project.idea.since-build" value="Set idea.since-build in project.properties"/>
        <property name="project.description" value="Set description in project.properties"/>
        <property name="project.change-notes" value="Set change-notes in project.properties"/>
        <property name="project.homedir" value="Set homedir in project.properties"/>

        <property name="binary.extensions" value="**/*.png, **/*.jpg, **/*.jpeg, **/*.gif"/>

        <!-- Folders -->
        <property name="src.etc.dir" value="src/etc"/>
        <property name="src.java.dir" value="src/java"/>
        <property name="src.test.dir" value="src/test"/>

        <property name="lib.dir" value="lib"/>
        <property name="lib.compile.dir" value="${lib.dir}/compile"/>
        <property name="lib.runtime.dir" value="${lib.dir}/runtime"/>

        <property name="build.dir" value="build"/>
        <property name="classes.dir" value="${build.dir}/classes"/>
        <property name="dist.dir" value="${build.dir}/dist"/>
        <property name="test.classes.dir" value="${build.dir}/test-classes"/>
        <property name="test.results.dir" value="${build.dir}/test-results"/>
        <property name="test.reports.dir" value="${build.dir}/test-reports"/>

        <property name="irida.home" value="${lib.compile.dir}/irida"/>
        <property name="irida.classes.dir" value="${classes.dir}/irida"/>
        <property name="irida.test.classes.dir" value="${test.classes.dir}/irida"/>
        <property name="irida.test.results.dir" value="${test.results.dir}/irida"/>
        <property name="irida.test.reports.dir" value="${test.reports.dir}/irida"/>

        <property name="irida.plugins.dir" value="${irida.home}/config/plugins"/>
        <property name="distfile.name" value="${project.name}-${project.version}"/>

        <!-- Variable for tokenisation -->
        <filterset id="project.variables">
            <filter token="PROJECT.NAME" value="${project.name}"/>
            <filter token="PROJECT.HOMEPAGE" value="${project.homepage}"/>
            <filter token="PROJECT.VERSION" value="${project.version}"/>
            <filter token="PROJECT.DESCRIPTION" value="${project.description}"/>
            <filter token="PROJECT.CHANGE-NOTES" value="${project.change-notes}"/>
            <filter token="PROJECT.VENDOR" value="${project.vendor}"/>
            <filter token="PROJECT.VENDOR.EMAIL" value="${project.vendor.email}"/>
            <filter token="PROJECT.VENDOR.HOMEPAGE" value="${project.vendor.homepage}"/>
        </filterset>

        <path id="compile.classpath">
            <fileset dir="${lib.compile.dir}">
                <include name="**/*.jar"/>
                <exclude name="irida/**/*.jar"/>
            </fileset>
            <fileset dir="${lib.runtime.dir}">
                <include name="**/*.jar"/>
            </fileset>
        </path>

        <path id="irida.compile.classpath">
            <fileset dir="${irida.home}">
                <include name="**/*.jar"/>
            </fileset>
            <pathelement location="${irida.classes.dir}"/>
            <path refid="compile.classpath"/>
        </path>

        <path id="irida.test.classpath">
            <pathelement location="${irida.test.classes.dir}"/>
            <path refid="irida.compile.classpath"/>
        </path>

        <tstamp>
            <format property="TODAY" pattern="d-MMMM-yyyy" locale="en"/>
            <format property="DAY" pattern="d" locale="en"/>
            <format property="MONTH" pattern="MM" locale="en"/>
            <format property="YEAR" pattern="yyyy" locale="en"/>
        </tstamp>

        <filterset id="timestamp.variables">
            <filter token="TIMESTAMP" value="${TODAY}"/>
            <filter token="DAY" value="${DAY}"/>
            <filter token="MONTH" value="${MONTH}"/>
            <filter token="YEAR" value="${YEAR}"/>
        </filterset>
    </target>

    <target name="check.irida.available" depends="initialise.build" >
        <available property="irida.available"
                   classname="com.intellij.lang.Language"
                   classpathref="irida.test.classpath"/>
    </target>

    <target name="irida.available" depends="check.irida.available" unless="irida.available">
        <fail>IntelliJ IDEA (Irida) is not available. Please either define 'irida.home' in project.properties or copy
              $IDEA_HOME/lib/extensions.jar, $IDEA_HOME/lib/idea.jar, $IDEA_HOME/lib/openapi.jar,
              $IDEA_HOME/lib/picocontainer.jar and $IDEA_HOME/lib/trove4j.jar to ${irida.home}/lib.
        </fail>
    </target>

    <target name="clean" depends="initialise.build" description="Deletes all artifacts from a previous build">
        <delete dir="${build.dir}"/>
    </target>

    <target name="compile.irida" depends="irida.available">
        <mkdir dir="${irida.classes.dir}"/>
        <javac srcdir="${src.java.dir}" destdir="${irida.classes.dir}" debug="on">
            <classpath refid="irida.compile.classpath"/>
        </javac>
        <copy todir="${irida.classes.dir}" overwrite="true" preservelastmodified="true">
            <fileset dir="${src.etc.dir}" includes="${binary.extensions}"/>
        </copy>
    </target>

    <target name="compile" depends="compile.irida" description="Compiles the project source files"/>

    <target name="compile.tests.irida" depends="compile.irida">
        <mkdir dir="${irida.test.classes.dir}"/>
        <javac srcdir="${src.test.dir}" destdir="${irida.test.classes.dir}" debug="on">
            <classpath refid="irida.test.classpath"/>
        </javac>
    </target>

    <target name="compile.tests" depends="compile.tests.irida"/>

    <target name="test.irida" depends="compile.tests.irida">
        <mkdir dir="${irida.test.results.dir}"/>

        <junit fork="true" forkmode="once" errorProperty="tests.failed" failureProperty="tests.failed"
               haltonfailure="false" haltonerror="false" showoutput="true" printsummary="withOutAndErr"
               includeantruntime="true" newenvironment="false">

            <classpath refid="irida.test.classpath"/>
            <formatter type="brief" usefile="false"/>

            <batchtest todir="${irida.test.results.dir}">
                <fileset dir="${irida.test.classes.dir}">
                    <include name="**/*Test.class"/>
                    <include name="**/Create*TestCase.class"/>
                </fileset>
                <formatter type="xml"/>
            </batchtest>
        </junit>
    </target>

    <target name="test.reports.irida" depends="test.irida">
        <mkdir dir="${irida.test.reports.dir}"/>
        <junitreport todir="${irida.test.results.dir}">
            <fileset dir="${irida.test.results.dir}">
                <include name="TEST-*.xml"/>
            </fileset>
            <report format="frames" todir="${irida.test.reports.dir}"/>
        </junitreport>

        <fail message="Tests failed! Check test reports." if="tests.failed"/>
    </target>

    <target name="jar.irida" depends="test.reports.irida" description="Packages up the plug-in as a jar file for IDEA Irida">
        <copy todir="${irida.classes.dir}" overwrite="true" preservelastmodified="true">
            <fileset dir="${src.etc.dir}" excludes="styles/**/*, ${binary.extensions}"/>
            <filterset>
                <filter token="PROJECT.TITLE" value="Groovy Integration"/>
                <filter token="PROJECT.IDEA.SINCE-BUILD" value="3214"/>
            </filterset>
            <filterset refid="project.variables"/>
            <filterset refid="timestamp.variables"/>
        </copy>

        <mkdir dir="${dist.dir}"/>
        <jar basedir="${irida.classes.dir}" compress="true" update="true" destfile="${dist.dir}/${distfile.name}-irida.jar"/>
    </target>

    <target name="zip.irida" depends="jar.irida" description="Packages up the plug-in as a deployable zip file for IDEA Irida">
        <zip compress="true" update="true" destfile="${dist.dir}/${distfile.name}-irida.zip">
            <zipfileset prefix="${project.name}/lib" file="${dist.dir}/${distfile.name}-irida.jar"/>
            <zipfileset prefix="${project.name}/lib" dir="${lib.runtime.dir}"/>
        </zip>
        <delete file="${dist.dir}/${distfile.name}-irida.jar"/>
    </target>

    <target name="build.all" depends="zip.irida" description="Creates all installable plug-in distributions">
        <buildnumber/>
    </target>

    <target name="deploy.irida" depends="zip.irida" description="Deploys the plug-in into an IntelliJ IDEA installation">
        <delete dir="${irida.plugins.dir}/${project.name}" failonerror="true"/>
        <unzip src="${dist.dir}/${distfile.name}-irida.zip" dest="${irida.plugins.dir}"/>

        <copy file="${src.etc.dir}/idea/Groovy Script Files.xml"
              todir="${irida.plugins.dir}/../filetypes/" overwrite="true"/>

        <copy file="${src.etc.dir}/idea/GroovyJ Code Style.xml"
              todir="${irida.plugins.dir}/../codestyles/" overwrite="true"/>
    </target>

</project>
